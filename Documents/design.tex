\documentclass[14pt]{article}

\usepackage[letterpaper, landscape, margin=1.5cm]{geometry}

\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}

\usepackage{microtype}	

\usepackage[simplified]{pgf-umlcd}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric,backgrounds,calc,positioning,arrows,
                chains,decorations.markings,patterns,fadings,shapes.multipart,trees}

\usepackage[colorinlistoftodos,prependcaption,textsize=medium]{todonotes}

\begin{document}

\section{Структура базы данных}

\begin{center}
  \ttfamily
  \begin{tikzpicture}
    \begin{class}[text width=4cm]{User}{0, 5}
        \attribute{id : Integer (\textbf{PK})}
        \attribute{password : String}
        \attribute{registration : Date}
        \attribute{surname : String}
        \attribute{name : String}
        \attribute{patronymic : String}
        \attribute{email: String}
        \attribute{birthday: Date}
        \attribute{role: UserRole enum}
    \end{class}
    
    \begin{class}[text width=3cm]{UserRole}{10, 0}
    	\attribute{* Student}
    	\attribute{* Parent}
    	\attribute{* Сommittee}
    	\attribute{* Teacher}
    	\attribute{* Administrator}
    \end{class}
    
    \begin{class}{Relationship}{-10, 0}
       \attribute{id : Integer (\textbf{PK})}
       \attribute{parent : Integer (\textbf{FK})}
       \attribute{child : Integer (\textbf{FK})}
       \attribute{state : RequestState enum}
    \end{class}
    
    \begin{class}[text width=3cm]{RequestState}{-10, -5}
      \attribute{* Waiting}
      \attribute{* Approved}
      \attribute{* Declined}
    \end{class}

    \begin{class}{GroupList}{4, -3}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{userId : Integer (\textbf{FK})}
      \attribute{groupId : Integer (\textbf{FK})}
      \attribute{state : GroupListState enum}
    \end{class}
    
    \begin{class}{GroupRequest}{-3, -1}
    	\attribute{id : Integer (\textbf{PK})}
      	\attribute{userId : Integer (\textbf{FK})}
      	\attribute{groupId : Integer (\textbf{FK})}
      	\attribute{state : GroupRequestState enum}
    \end{class}

    \begin{class}{Group}{10,5}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{periodId : Integer (\textbf{FK})}
      \attribute{name : String}
      \attribute{description : String}
      \attribute{isOpen : bool}
      \attribute{limit: Integer}
      \attribute{type : GroupType enum}
    \end{class}
  
    \begin{class}{Period}{10,10}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{name : String}
      \attribute{beginDate : Date}
      \attribute{endDate : Date}
    \end{class}
    
    \begin{class}[text width=2cm]{GroupType}{5, 7}
      \attribute{* Study}
      \attribute{* Camp}
    \end{class}
    
	\begin{class}[text width=3.5cm]{GroupRequestState}{-3, -5}
		\attribute{* Testing}
		\attribute{* TestingSucceeded}
		\attribute{* TestingFailed}
	\end{class} 
	
	\begin{class}[text width=3cm]{GroupListState}{10, -5}
		\attribute{* Studing}
		\attribute{* Successed}
		\attribute{* Failed}
		\attribute{* Disqualified}
	\end{class}
       
    \begin{class}{CampVouchers}{0, 10}
    	\attribute{id : Integer (\textbf{PK})}
    	\attribute{userId : Integer (\textbf{FK})}
    	\attribute{periodId : Integer (\textbf{FK})}
    	\attribute{state : CampVoucherState enum}
    \end{class}
    
    \begin{class}{CampVoucherState}{-10, 10}
      \attribute{* WaitingPayment}
      \attribute{* Declined}
      \attribute{* Paid}
      \attribute{* Approved}
    \end{class}
    
    \begin{class}{School}{-10, 6}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{name : String}
      \attribute{address : String}
    \end{class}
    
    \begin{class}{SchoolEducation}{-10, 3}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{userId : Integer (\textbf{FK})}
      \attribute{schoolId : Integer (\textbf{FK})}
      \attribute{class : Integer}
    \end{class}

    \association{User}{}{1}{GroupList}{}{0..*}
    \association{User}{}{0..*}{Relationship}{}{0..*}
    \association{User}{}{}{UserRole}{}{}
    \association{User}{}{1}{CampVouchers}{}{1}
    \association{User}{}{1}{SchoolEducation}{}{0..*}
    
    \association{Relationship}{}{}{RequestState}{}{}
    
	\association{GroupRequest}{}{}{GroupRequestState}{}{} 
	\association{GroupRequest}{}{0..*}{Group}{}{1} 
	\association{GroupRequest}{}{0..*}{User}{}{1}   
    
    \association{GroupList}{}{0..*}{Group}{}{1}
    \association{GroupList}{}{}{GroupListState}{}{}
        
    \association{Period}{}{1}{Group}{}{0..*}
    \association{Period}{}{1}{CampVouchers}{}{1}
    
    \association{Group}{}{}{GroupType}{}{}
    
    \association{GroupRequestState}{}{}{RequestState}{Inheritance}{}

    \association{CampVouchers}{}{}{CampVoucherState}{}{}
    
    \association{School}{}{1}{SchoolEducation}{}{0..*}
  \end{tikzpicture}
\end{center}

\begin{itemize}
    \item PK - Primary Key (желательно случайные уникальные символы, чтобы нельзя было просто так итерироваться)
    \item FK - Foreign Key
    \item UK - Unique Key
\end{itemize}

\section{Сущности}

\subsection{Пользователь (User)}

Пользователь сайта. 

Атрибуты:

\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{password}~---~пароль пользователя;
	\item \emph{registration}~---~дата регистрации на сайте;
	\item \emph{surname}~---~Фамилия пользователя;
	\item \emph{name}~---~Имя пользователя;
	\item \emph{patronymic}~---~Отчество пользователя;
	\item \emph{email}~---~ E-Mail пользователя;
	\item \emph{birthday}~---~ Дата рождения пользователя;
    \item \emph{role}~---~Роль пользователя в системе, может быть перезаписана непустой ролью в группе;
\end{itemize}

\subsection{Роли пользователей (UserRole)}

У пользователей сайта могут быть разные роли: возможности и уровень доступа у разных пользователей могут отличаться для разных групп.
Текущие роли:
\begin{itemize}
    \item None
	\item Ученик (Student);
	\item Родитель (Parent);
	\item Представитель комитета (Committee);
	\item Преподаватель (Teacher);
	\item Админстратор (Administrator).
\end{itemize}

\subsection{Родственники (Relationship)}

Таблица, устанавливающая связи между пользователями с ролью ``Родитель'' и ``Ученик'' и отслеживающая состояние заявок на родство между пользователеми.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{parent}~---~ссылка на id пользователя-родителя, является FK;
	\item \emph{child}~---~ссылка на id пользователя-ученика (ребенка), является FK;
	\item \emph{state}~---~состояние заявки на родство между пользователями, является экземпляром перечисления ``Состояние заявки''.
\end{itemize}

\todo[inline]{N.B! Возможно, необходимо добавить статус родителя? Т.е. указать кто он ребенку~---~папа, мама, брат, сестра, etc.}

\subsection{Состояние заявки (RequestState)}

Состояние заявки.

Текущие состояния:
\begin{itemize}
	\item \emph{Waiting}~---~Заявка отправлена и ожидает принятия или отказа;
	\item \emph{Approved}~---~Заявка принята;
	\item \emph{Declined}~---~В заявке отказано.
\end{itemize}

\subsection{Период обучения (Period)}

Учебный период в КШ.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{name}~---~название учебного периода;
	\item \emph{beginDate}~---~начало периода;
	\item \emph{endDate}~---~окончание периода.
\end{itemize}
	
\subsection{Группа (Group)}

Группы объединяют пользователей. Каждый из них может входить в любое количество групп.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{periodId}~---~ссылка на учебный период, к которому относится группа, является FK;
	\item \emph{name}~---~название учебной группы;
	\item \emph{description}~---~описание группы;
	\item \emph{isOpen}~---~открыт ли набор в данную группу, \emph{true} в случае, если открыт, в противном~---~\emph{false};
	\item \emph{limit}~---~максимальное количество возможных участников группы;	
	\item \emph{type}~---~тип группы, является экземпляром перечисления ``Тип группы''.
\end{itemize}

\subsection{Заявка в группу (GroupRequest)}

Список заявок участников в группы.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-участника, является FK;
	\item \emph{groupId}~---~ссылка на группу, является FK;
	\item \emph{state}~---~состояние заявки на вступление, является экземпляром перечисления ``Состояние заявки в группу''.
\end{enumerate}

\todo[inline]{N.B! Может здесь нужно ещё хранить количество попыток тестирования?}

\subsection{Состояние заявки в группу (GroupRequestState)}

Состояние заявки ученика в группу. Включает в себя элементы перечисления ``Состояние заявки'' и добавляет свои состояния.

Основные состояние из ``Состояние заявки'' (RequestState):

\begin{itemize}
	\item \emph{Waiting}~---~Ученик ожидает тестирования или вхождения в группу;
	\item \emph{Approved}~---~Заявка принята и ученик находится в группе;
	\item \emph{Declined}~---~В заявке отказано навсегда, ученик не имеет права падавать заявки в данную группу.
\end{itemize}

Дополнительные состояния:
\begin{enumerate}
	\item \emph{Testing}~---~участник тестируется на вхождению в группу;
	\item \emph{TestingSucceeded}~---~участник успешно сдал тест;
	\item \emph{TestingFailed}~---~участник провалил тестирование, но в возможность участия в группе для него окончательно не отменена и он может сдать тест ещё раз.
\end{enumerate}

Типичный сценарий изменения состояния заявки ученика:

\begin{enumerate}
	\item Waiting~---~опциональная задержка на тестирование ученика
	\item Testing~---~ученик выбрал группу и на данный момент времени проходит тестирование;
	\item TestingSucceeded~---~тест пройден успешно;
	\item Approved~---~ученик находится в группе.
\end{enumerate}

ИЛИ

\begin{enumerate}
	\item Testing;
	\item TestingFailed~---~тест провален и ученик пытается ещё раз сделать тестирование;
	\item ... (опять Testing и так далее)
	\item Approved или Declined (ученик либо добил тест и попал в группу, либо его окончательно забанили)
\end{enumerate}

\subsection{Участники группы (GroupList)}

Список участников группы. Используется как и для учебных групп, так и для отрядов. Сюда заносятся все записи из таблицы \emph{GroupRequest}, у которых поле \emph{state} равно значению <<Approved>>.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-участника, является FK;
	\item \emph{groupId}~---~ссылка на группу, является FK;
	\item \emph{state}~---~состояние пользователя ``Состояние участия в группе''.
\end{enumerate}

\subsection{Состояние участия в группе (GroupListState)}

Состояние участия в группе\textbackslash отряде.

Текущие состояния:
\begin{itemize}
	\item \emph{Studing}~---~Пользователь работает в группе или находится в отряде; 
	\item \emph{Successed}~---~Пользователь успешно окончил обучение в группе или закончил пребывание в отряде, потому что смена закончилась;
	\item \emph{Failed}~---~Ученик закончил обучение, но провалил заключительную проверку;
	\item \emph{Disqualified}~---~Ученик отчислен из группы или из отряда (выгнали из лагеря?).
\end{itemize}

\subsection{Тип группы (GroupType)}

Группы могут быть двух типов: учебные (Study) и отряды в лагере (Camp).

\subsection{Путевки (CampVouchers)}

Путевки учеников на участие в смене ЛКШ.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-участника, является FK;
	\item \emph{periodId}~---~ссылка на учебный период, к которому относится группа, является FK;
	\item \emph{state}~---~состояние путевки на участие в смене, является экземпляром перечисления ``Состояние путевки на участие в смене''. 
\end{enumerate}

\subsection{Состояние путевки на участие в смене (CampVoucherState)}

Состояние путевки на участие в смене.

Текущие состояния:

\begin{enumerate}
	\item \emph{WaitingPayment}~---~путевка ожидает оплаты;
	\item \emph{Declined}~---~путевка отклонена;
	\item \emph{Paid}~---~путевка оплачена;
	\item \emph{Approved}~---~путевка одобрена.
\end{enumerate}

\subsection{School}

Таблица, описывающая школу.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{name}~---~название школы;
	\item \emph{address}~---~адрес школы;
\end{enumerate}

\subsection{SchoolEducation}

Таблица, которая описывает стадию обучения школьника~---~в какой школе и в каком классе он сейчас обучается.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-школьника, является FK;
	\item \emph{schoolId}~---~ссылка на школу, является FK;
	\item \emph{class}~---~текущий класс школьника;
\end{enumerate}

\end{document}
