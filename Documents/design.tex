\documentclass[14pt]{article}

\usepackage[letterpaper, landscape, margin=1.5cm]{geometry}

\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}

\usepackage[simplified]{pgf-umlcd}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric,backgrounds,calc,positioning,arrows,
                chains,decorations.markings,patterns,fadings,shapes.multipart,trees}

\begin{document}

\section{Структура базы данных}

\begin{center}
  \ttfamily
  \begin{tikzpicture}
    \begin{class}[text width=6cm]{User}{0, 5}
        \attribute{id : Integer (\textbf{PK})}
        \attribute{registration : Date}
        \attribute{surname : String}
        \attribute{name : String}
        \attribute{patronymic : String}
        \attribute{email: String}
        \attribute{birthday: Date}
        \attribute{role: UserRole enum}
    \end{class}
    
    \begin{class}{UserRole}{10, -3}
    	\attribute{* Student}
    	\attribute{* Parent}
    	\attribute{* Сommittee}
    	\attribute{* Teacher}
    	\attribute{* Administrator}
    \end{class}
    
    \begin{class}{Relationship}{-10, 0}
       \attribute{id : Integer (\textbf{PK})}
       \attribute{parent : Integer (\textbf{FK})}
       \attribute{child : Integer (\textbf{FK})}
       \attribute{state : RequestState enum}
    \end{class}
    
    \begin{class}{RequestState}{-10, -5}
      \attribute{* Waiting}
      \attribute{* Approved}
      \attribute{* Declined}
    \end{class}

    \begin{class}{GroupList}{0,0}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{userId : Integer (\textbf{FK})}
      \attribute{groupId : Integer (\textbf{FK})}
      \attribute{state : RequestState}
      \attribute{role : UserRole enum}
    \end{class}

    \begin{class}{Group}{10,5}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{periodId : Integer (\textbf{FK})}
      \attribute{name : String}
      \attribute{isOpen : bool}
      \attribute{type : GroupListStatus enum}
    \end{class}
  
    \begin{class}{Period}{10,10}
      \attribute{id : Integer (\textbf{PK})}
      \attribute{name : String}
      \attribute{beginDate : Date}
      \attribute{endDate : Date}
    \end{class}
    
    \begin{class}{GroupType}{10, 0}
      \attribute{* Study}
      \attribute{* Camp}
    \end{class}
    
	\begin{class}{GroupListStatus}{0, -5}
		\attribute{* Testing}
		\attribute{* TestingSucceeded}
		\attribute{* TestingFailed}
	\end{class}   
       
    \begin{class}{CampVouchers}{0, 10}
    	\attribute{id : Integer (\textbf{PK})}
    	\attribute{userId : Integer (\textbf{FK})}
    	\attribute{periodId : Integer (\textbf{FK})}
    	\attribute{state : CampVoucherState enum}
    \end{class}
    
    \begin{class}{CampVoucherState}{-10, 10}
      \attribute{* WaitingPayment}
      \attribute{* Declined}
      \attribute{* Paid}
      \attribute{* Approved}
    \end{class}

    \association{User}{}{0..*}{GroupList}{}{}
    \association{User}{}{}{Relationship}{}{}
    \association{User}{}{}{UserRole}{}{}
    \association{User}{}{}{CampVouchers}{}{}
    
    \association{Relationship}{}{}{RequestState}{}{}
    
    \association{GroupList}{}{}{Group}{}{0..*}
    \association{GroupList}{}{}{UserRole}{}{}
        
    \association{Period}{}{1}{Group}{}{0..*}
    \association{Period}{}{}{CampVouchers}{}{}
    
    \association{Group}{}{}{GroupType}{}{}
    
    \association{GroupListStatus}{}{}{RequestState}{Inheritance}{}
    \association{GroupListStatus}{}{}{GroupList}{}{}

    \association{CampVouchers}{}{}{CampVoucherState}{}{}
  \end{tikzpicture}
\end{center}

\begin{itemize}
    \item PK - Primary Key (желательно случайные уникальные символы, чтобы нельзя было просто так итерироваться)
    \item FK - Foreign Key
    \item UK - Unique Key
\end{itemize}

\section{Сущности}

\subsection{Пользователь (User)}

Пользователь сайта. 

Атрибуты:

\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{registration}~---~дата регистрации на сайте;
	\item \emph{surname}~---~Фамилия пользователя;
	\item \emph{name}~---~Имя пользователя;
	\item \emph{patronymic}~---~Отчество пользователя;
    \item \emph{role}~---~Роль пользователя в системе, может быть перезаписана непустой ролью в группе.
\end{itemize}

\subsection{Роли пользователей (UserRole)}

У пользователей сайта могут быть разные роли: возможности и уровень доступа у разных пользователей могут отличаться для разных групп.
Текущие роли:
\begin{itemize}
    \item None
	\item Ученик (Student);
	\item Родитель (Parent);
	\item Представитель комитета (Committee);
	\item Преподаватель (Teacher);
	\item Админстратор (Administrator).
\end{itemize}

\subsection{Родственники (Relationship)}

Таблица, устанавливающая связи между пользователями с ролью ``Родитель'' и ``Ученик'' и отслеживающая состояние заявок на родство между пользователеми.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{parent}~---~ссылка на id пользователя-родителя, является FK;
	\item \emph{child}~---~ссылка на id пользователя-ученика (ребенка), является FK;
	\item \emph{state}~---~состояние заявки на родство между пользователями, является экземпляром перечисления ``Состояние заявки''.
\end{itemize}

\subsection{Состояние заявки (RequestState)}

Состояние заявки.

Текущие состояния:
\begin{itemize}
	\item \emph{Waiting}~---~Заявка отправлена и ожидает принятия или отказа;
	\item \emph{Approved}~---~Заявка принята;
	\item \emph{Declined}~---~В заявке отказано.
\end{itemize}

\subsection{Период обучения (Period)}

Учебный период в КШ.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{name}~---~название учебного периода;
	\item \emph{beginDate}~---~начало периода;
	\item \emph{endDate}~---~окончание периода.
\end{itemize}

\subsection{Группа (Group)}

Группы объединяют пользователей. Каждый из них может входить в любое количество групп.

Атрибуты:
\begin{itemize}
	\item \emph{id}~---~идентификатор пользователя, является PK;
	\item \emph{periodId}~---~ссылка на учебный период, к которому относится группа, является FK;
	\item \emph{name}~---~название учебной группы;
	\item \emph{isOpen}~---~открыт ли набор в данную группу, \emph{true} в случае, если открыт, в противном~---~\emph{false};
	\item \emph{type}~---~тип группы, является экземпляром перечисления ``Тип группы''.
\end{itemize}

\subsection{Список группы (GroupList)}

Список участников групп. Каждая запись указывается принадлежность пользователя к группе. 

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-участника, является FK;
	\item \emph{groupId}~---~ссылка на группу, является FK;
	\item \emph{state}~---~состояние заявки на вступление, является экземпляром перечисления ``Состояние заявки в группу''.
    \item \emph{role}~---~роль участника в группе, непустое значение перезапишет User.role для данной группы
\end{enumerate}

Атрибут \emph{state} также указывает на \textbf{нахождение} пользователя в группу! Подробнее, смотри  ``Состояние заявки в группу''.

\textit{N.B. Может здесь нужно ещё хранить количество попыток тестирования?}

\subsection{Состояние заявки в группу (GroupListStatus)}

Состояние заявки ученика в группу. Включает в себя элементы перечисления ``Состояние заявки'' и добавляет свои состояния.

Основные состояние из ``Состояние заявки'' (RequestState):

\begin{itemize}
	\item \emph{Waiting}~---~Ученик ожидает тестирования или вхождения в группу;
	\item \emph{Approved}~---~Заявка принята и ученик находится в группе;
	\item \emph{Declined}~---~В заявке отказано навсегда, ученик не имеет права падавать заявки в данную группу.
\end{itemize}

Дополнительные состояния:
\begin{enumerate}
	\item \emph{Testing}~---~участник тестируется на вхождению в группу;
	\item \emph{TestingSucceeded}~---~участник успешно сдал тест;
	\item \emph{TestingFailed}~---~участник провалил тестирование, но в возможность участия в группе для него окончательно не отменена и он может сдать тест ещё раз.
\end{enumerate}

Типичный сценарий изменения состояния заявки ученика:

\begin{enumerate}
	\item Waiting~---~опциональная задержка на тестирование ученика
	\item Testing~---~ученик выбрал группу и на данный момент времени проходит тестирование;
	\item TestingSucceeded~---~тест пройден успешно;
	\item Approved~---~ученик находится в группе.
\end{enumerate}

ИЛИ

\begin{enumerate}
	\item Testing;
	\item TestingFailed~---~тест провален и ученик пытается ещё раз сделать тестирование;
	\item ... (опять Testing и так далее)
	\item Approved или Declined (ученик либо добил тест и попал в группу, либо его окончательно забанили)
\end{enumerate}

Поиск участников определенной группы: SELECT userId FROM GroupList WHERE groupId = someId AND state = Approved

\subsection{Тип группы (GroupType)}

Группы могут быть двух типов: учебные (Study) и отряды в лагере (Camp).

\subsection{Путевки (CampVouchers)}

Путевки учеников на участие в смене ЛКШ.

Атрибуты:
\begin{enumerate}
	\item \emph{id}~---~идентификатор пользователя, является PK; 
	\item \emph{userId}~---~ссылка на пользователя-участника, является FK;
	\item \emph{periodId}~---~ссылка на учебный период, к которому относится группа, является FK;
	\item \emph{state}~---~состояние путевки на участие в смене, является экземпляром перечисления ``Состояние путевки на участие в смене''. 
\end{enumerate}

\subsection{Состояние путевки на участие в смене (CampVoucherState)}

Состояние путевки на участие в смене.

Текущие состояния:

\begin{enumerate}
	\item \emph{WaitingPayment}~---~путевка ожидает оплаты;
	\item \emph{Declined}~---~путевка отклонена;
	\item \emph{Paid}~---~путевка оплачена;
	\item \emph{Approved}~---~путевка одобрена.
\end{enumerate}

\end{document}
